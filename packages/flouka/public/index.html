<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON Resume to PDF Converter</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #14b8a6 0%, #10b981 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #14b8a6 0%, #10b981 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .main-content {
      display: grid;
      grid-template-columns: 400px 1fr;
      min-height: calc(100vh - 200px);
    }

    .sidebar {
      background: #f8f9fa;
      padding: 30px;
      border-right: 1px solid #dee2e6;
      overflow-y: auto;
      max-height: calc(100vh - 200px);
    }

    .preview-area {
      padding: 30px;
      background: white;
      overflow-y: auto;
      max-height: calc(100vh - 200px);
    }

    .section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 1.2em;
      font-weight: 600;
      margin-bottom: 15px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title::before {
      content: "";
      width: 4px;
      height: 20px;
      background: #14b8a6;
      border-radius: 2px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      color: #495057;
      font-size: 0.9em;
    }

    textarea, input[type="number"], input[type="range"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      transition: border-color 0.2s;
    }

    textarea:focus, input:focus {
      outline: none;
      border-color: #14b8a6;
    }

    textarea {
      min-height: 200px;
      resize: vertical;
    }

    .btn {
      background: linear-gradient(135deg, #14b8a6 0%, #10b981 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
      margin-top: 10px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(20, 184, 166, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: #6c757d;
    }

    .validation-message {
      padding: 12px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 0.9em;
    }

    .validation-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .validation-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .draggable-list {
      list-style: none;
      padding: 0;
    }

    .draggable-item {
      background: white;
      padding: 12px 15px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: move;
      border: 2px solid #dee2e6;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s;
    }

    .draggable-item:hover {
      border-color: #14b8a6;
      box-shadow: 0 2px 8px rgba(20, 184, 166, 0.2);
    }

    .draggable-item.dragging {
      opacity: 0.5;
    }

    .drag-handle {
      font-size: 1.2em;
      color: #6c757d;
    }

    .page-break-controls {
      display: flex;
      gap: 10px;
      margin-left: auto;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85em;
      color: #6c757d;
      cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
      width: auto;
      cursor: pointer;
    }

    .remove-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      cursor: pointer;
      transition: background 0.2s;
    }

    .remove-btn:hover {
      background: #c82333;
    }

    .range-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .range-value {
      min-width: 50px;
      text-align: center;
      font-weight: 600;
      color: #14b8a6;
    }

    .preview-frame {
      width: 100%;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      min-height: 800px;
      background: white;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
      font-size: 1.1em;
    }

    .file-upload {
      border: 2px dashed #14b8a6;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background: #f0fdfa;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 15px;
    }

    .file-upload:hover {
      background: #ccfbf1;
      border-color: #0d9488;
    }

    .file-upload input[type="file"] {
      display: none;
    }

    .upload-icon {
      font-size: 2em;
      margin-bottom: 10px;
    }

    @media (max-width: 1200px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        border-right: none;
        border-bottom: 1px solid #dee2e6;
        max-height: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìÑ JSON Resume to PDF</h1>
      <p>Upload or paste your JSON Resume, customize the layout, and generate a professional PDF</p>
    </div>

    <div class="main-content">
      <div class="sidebar">
        <!-- JSON Input Section -->
        <div class="section">
          <div class="section-title">JSON Resume Input</div>
          
          <div class="file-upload" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept=".json" />
            <div class="upload-icon">üìÅ</div>
            <div>Click to upload JSON file</div>
            <div style="font-size: 0.9em; color: #6c757d; margin-top: 5px;">or drag and drop</div>
          </div>

          <div class="input-group">
            <label for="jsonInput">Or paste JSON Resume here:</label>
            <textarea id="jsonInput" placeholder='{\n  "basics": {\n    "name": "Your Name",\n    ...\n  }\n}'></textarea>
          </div>

          <div id="validationMessage"></div>
        </div>

        <!-- Configuration Section -->
        <div class="section">
          <div class="section-title">Configuration</div>

          <div class="input-group">
            <label>Font Size: <span class="range-value" id="fontSizeValue">12pt</span></label>
            <input type="range" id="fontSize" min="8" max="18" value="12" step="0.5">
          </div>

          <div class="input-group">
            <label>Line Height: <span class="range-value" id="lineHeightValue">1.5</span></label>
            <input type="range" id="lineHeight" min="1" max="2.5" value="1.5" step="0.1">
          </div>
        </div>

        <!-- Section Order -->
        <div class="section">
          <div class="section-title">Section Order & Page Breaks</div>
          <p style="font-size: 0.9em; color: #6c757d; margin-bottom: 15px;">
            Drag to reorder sections. Check boxes to add page breaks. Click ‚úï to remove.
          </p>
          <ul id="sectionList" class="draggable-list"></ul>
          <button class="btn btn-secondary" onclick="restoreAllSections()" style="margin-top: 10px; font-size: 0.9em;">
            ‚Ü∫ Restore Removed Sections
          </button>
        </div>

        <!-- Action Buttons -->
        <div class="section">
          <button class="btn" onclick="updatePreview()">üîÑ Update Preview</button>
          <button class="btn" onclick="generatePDF()">üì• Download PDF</button>
          <button class="btn btn-secondary" onclick="loadExample()">üìã Load Example</button>
        </div>
      </div>

      <div class="preview-area">
        <div class="section-title">Preview</div>
        <div id="previewContainer" class="loading">
          Upload or paste a JSON Resume to see the preview
        </div>
      </div>
    </div>
  </div>

  <script>
    // Default sections
    const DEFAULT_SECTIONS = [
      "summary", "education", "work", "skills", "languages",
      "volunteer", "awards", "publications", "projects",
      "certificates", "interests", "references"
    ];

    // State
    let currentResume = null;
    let draggedItem = null;
    let removedSections = [];

    // Initialize
    function init() {
      const savedConfig = loadConfig();
      initializeSectionList(savedConfig);
      setupEventListeners();
      setupDragAndDrop();
      
      // Apply saved config after DOM is ready
      if (savedConfig) {
        setTimeout(() => applyConfig(savedConfig), 0);
      }
    }

    function initializeSectionList(savedConfig) {
      const list = document.getElementById('sectionList');
      list.innerHTML = '';
      
      // Use saved section order if available, otherwise use defaults
      const sections = savedConfig?.sectionOrder || DEFAULT_SECTIONS;
      
      sections.forEach(section => {
        const li = createSectionItem(section);
        list.appendChild(li);
      });
      
      // Restore removed sections
      if (savedConfig?.removedSections) {
        removedSections = savedConfig.removedSections;
      }
    }

    function createSectionItem(section) {
      const li = document.createElement('li');
      li.className = 'draggable-item';
      li.draggable = true;
      li.dataset.section = section;
      
      li.innerHTML = `
        <span class="drag-handle">‚ò∞</span>
        <span style="flex: 1; text-transform: capitalize;">${section}</span>
        <div class="page-break-controls">
          <label class="checkbox-label">
            <input type="checkbox" class="break-before" data-section="${section}">
            <span>Before</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" class="break-after" data-section="${section}">
            <span>After</span>
          </label>
          <button class="remove-btn" data-section="${section}">‚úï</button>
        </div>
      `;
      
      // Add click handler for remove button
      li.querySelector('.remove-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        removeSection(section);
      });
      
      return li;
    }

    function removeSection(section) {
      const item = document.querySelector(`[data-section="${section}"]`);
      if (item) {
        item.remove();
        removedSections.push(section);
        // Save config after removing section
        saveConfig(getConfigWithoutSaving());
      }
    }

    function restoreAllSections() {
      removedSections.forEach(section => {
        const list = document.getElementById('sectionList');
        const li = createSectionItem(section);
        list.appendChild(li);
      });
      removedSections = [];
      // Save config after restoring sections
      saveConfig(getConfigWithoutSaving());
    }

    function getConfigWithoutSaving() {
      const sections = [...document.querySelectorAll('#sectionList .draggable-item')]
        .map(item => item.dataset.section);
      
      const pageBreakBefore = [...document.querySelectorAll('.break-before:checked')]
        .map(cb => cb.dataset.section);
      
      const pageBreakAfter = [...document.querySelectorAll('.break-after:checked')]
        .map(cb => cb.dataset.section);
      
      return {
        sectionOrder: sections,
        pageBreakBefore,
        pageBreakAfter,
        baseFontSize: parseFloat(document.getElementById('fontSize').value),
        lineHeight: parseFloat(document.getElementById('lineHeight').value)
      };
    }

    function setupEventListeners() {
      // JSON input
      document.getElementById('jsonInput').addEventListener('input', debounce(validateJSON, 500));
      
      // File upload
      document.getElementById('fileInput').addEventListener('change', handleFileUpload);
      
      // Range inputs
      document.getElementById('fontSize').addEventListener('input', (e) => {
        document.getElementById('fontSizeValue').textContent = e.target.value + 'pt';
      });
      
      document.getElementById('lineHeight').addEventListener('input', (e) => {
        document.getElementById('lineHeightValue').textContent = e.target.value;
      });
    }

    function setupDragAndDrop() {
      const list = document.getElementById('sectionList');
      
      list.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('draggable-item')) {
          draggedItem = e.target;
          e.target.classList.add('dragging');
        }
      });
      
      list.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('draggable-item')) {
          e.target.classList.remove('dragging');
          // Save config after reordering
          saveConfig(getConfigWithoutSaving());
        }
      });
      
      list.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(list, e.clientY);
        const dragging = document.querySelector('.dragging');
        
        if (afterElement == null) {
          list.appendChild(dragging);
        } else {
          list.insertBefore(dragging, afterElement);
        }
      });
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.draggable-item:not(.dragging)')];
      
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    async function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const text = await file.text();
      document.getElementById('jsonInput').value = text;
      validateJSON();
    }

    async function validateJSON() {
      const input = document.getElementById('jsonInput').value.trim();
      const messageDiv = document.getElementById('validationMessage');
      
      if (!input) {
        messageDiv.innerHTML = '';
        return;
      }
      
      try {
        const resume = JSON.parse(input);
        
        // Use server-side validation
        const response = await fetch('/api/validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ resume })
        });
        
        const validation = await response.json();
        
        if (validation.valid) {
          currentResume = resume;
          messageDiv.innerHTML = '<div class="validation-message success">‚úì Valid JSON Resume</div>';
          updatePreview();
        } else {
          currentResume = null;
          
          // Build error/warning messages
          let errorHtml = '<div class="validation-message error">';
          errorHtml += '<strong>‚úó Invalid JSON Resume</strong><br><br>';
          
          if (validation.errors && validation.errors.length > 0) {
            errorHtml += '<strong>Schema Errors:</strong><ul style="margin: 10px 0; padding-left: 20px;">';
            validation.errors.forEach(err => {
              errorHtml += `<li><code>${err.path}</code>: ${err.message}</li>`;
            });
            errorHtml += '</ul>';
          }
          
          if (validation.warnings && validation.warnings.length > 0) {
            errorHtml += '<strong>Warnings:</strong><ul style="margin: 10px 0; padding-left: 20px;">';
            validation.warnings.forEach(warning => {
              errorHtml += `<li>${warning}</li>`;
            });
            errorHtml += '</ul>';
          }
          
          errorHtml += '</div>';
          messageDiv.innerHTML = errorHtml;
        }
      } catch (error) {
        currentResume = null;
        messageDiv.innerHTML = `<div class="validation-message error">‚úó ${error.message}</div>`;
      }
    }

    function getConfig() {
      const sections = [...document.querySelectorAll('#sectionList .draggable-item')]
        .map(item => item.dataset.section);
      
      const pageBreakBefore = [...document.querySelectorAll('.break-before:checked')]
        .map(cb => cb.dataset.section);
      
      const pageBreakAfter = [...document.querySelectorAll('.break-after:checked')]
        .map(cb => cb.dataset.section);
      
      const config = {
        sectionOrder: sections,
        pageBreakBefore,
        pageBreakAfter,
        baseFontSize: parseFloat(document.getElementById('fontSize').value),
        lineHeight: parseFloat(document.getElementById('lineHeight').value)
      };
      
      // Save to localStorage
      saveConfig(config);
      
      return config;
    }

    function saveConfig(config) {
      try {
        localStorage.setItem('resumeConfig', JSON.stringify({
          sectionOrder: config.sectionOrder,
          pageBreakBefore: config.pageBreakBefore,
          pageBreakAfter: config.pageBreakAfter,
          removedSections: removedSections
        }));
      } catch (e) {
        console.error('Failed to save config to localStorage:', e);
      }
    }

    function loadConfig() {
      try {
        const saved = localStorage.getItem('resumeConfig');
        if (!saved) return null;
        return JSON.parse(saved);
      } catch (e) {
        console.error('Failed to load config from localStorage:', e);
        return null;
      }
    }

    function applyConfig(config) {
      if (!config) return;
      
      // Restore removed sections
      if (config.removedSections) {
        removedSections = config.removedSections;
      }
      
      // Restore section order
      if (config.sectionOrder) {
        const list = document.getElementById('sectionList');
        list.innerHTML = '';
        
        config.sectionOrder.forEach(section => {
          const li = createSectionItem(section);
          list.appendChild(li);
        });
      }
      
      // Restore page breaks
      if (config.pageBreakBefore) {
        config.pageBreakBefore.forEach(section => {
          const checkbox = document.querySelector(`.break-before[data-section="${section}"]`);
          if (checkbox) checkbox.checked = true;
        });
      }
      
      if (config.pageBreakAfter) {
        config.pageBreakAfter.forEach(section => {
          const checkbox = document.querySelector(`.break-after[data-section="${section}"]`);
          if (checkbox) checkbox.checked = true;
        });
      }
    }

    async function updatePreview() {
      if (!currentResume) {
        return;
      }
      
      const container = document.getElementById('previewContainer');
      container.innerHTML = '<div class="loading">Generating PDF preview...</div>';
      
      try {
        const config = getConfig();
        
        const response = await fetch('/api/generate-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ resume: currentResume, config })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error);
        }
        
        const blob = await response.blob();
        const pdfUrl = URL.createObjectURL(blob);
        
        // Create iframe for PDF preview
        const iframe = document.createElement('iframe');
        iframe.className = 'preview-frame';
        iframe.src = pdfUrl;
        iframe.style.border = 'none';
        
        container.innerHTML = '';
        container.appendChild(iframe);
        
        // Clean up the blob URL when component updates
        iframe.addEventListener('load', () => {
          if (window.lastPdfUrl) {
            URL.revokeObjectURL(window.lastPdfUrl);
          }
          window.lastPdfUrl = pdfUrl;
        });
      } catch (error) {
        container.innerHTML = `<div class="validation-message error">Preview error: ${error.message}</div>`;
      }
    }

    async function generatePDF() {
      if (!currentResume) {
        alert('Please upload or paste a valid JSON Resume first');
        return;
      }
      
      try {
        const config = getConfig();
        
        const response = await fetch('/api/generate-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ resume: currentResume, config })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error);
        }
        
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentResume.basics.name.replace(/\s+/g, '_')}_resume.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (error) {
        alert('PDF generation error: ' + error.message);
      }
    }

    function loadExample() {
      const example = {
        "basics": {
          "name": "John Doe",
          "label": "Software Engineer",
          "email": "john.doe@example.com",
          "phone": "(555) 123-4567",
          "url": "https://johndoe.com",
          "summary": "Experienced software engineer with a passion for building scalable web applications and leading technical teams.",
          "location": {
            "city": "San Francisco",
            "countryCode": "US"
          }
        },
        "work": [
          {
            "name": "Tech Corp",
            "position": "Senior Software Engineer",
            "url": "https://techcorp.example.com",
            "startDate": "2020-01",
            "summary": "Led development of cloud-based applications",
            "highlights": [
              "Architected microservices platform",
              "Mentored junior developers"
            ]
          }
        ],
        "education": [
          {
            "institution": "University of Technology",
            "area": "Computer Science",
            "studyType": "Bachelor",
            "startDate": "2012-09",
            "endDate": "2016-06"
          }
        ],
        "skills": [
          {
            "name": "Programming",
            "keywords": ["JavaScript", "TypeScript", "Python", "Go"]
          }
        ]
      };
      
      document.getElementById('jsonInput').value = JSON.stringify(example, null, 2);
      validateJSON();
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
